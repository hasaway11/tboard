<!doctype html>
<html lang="ko"  xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
  <link href="/main.css" rel="stylesheet">
  <title>Document</title>
</head>
<body>
  <div id="app">
    <header th:replace="~{/fragment/header.html}">
    </header>
    <nav th:replace="~{/fragment/nav.html}">
    </nav>
    <main>
      <section>
        <table class="table mt-3">
          <tr>
            <td>작성일</td>
            <td th:text="${post.writeTime}"></td>
          </tr>
          <tr>
            <td>글쓴이</td>
            <td th:text="${post.writer}"></td>
          </tr>
          <tr>
            <td>제목</td>
            <td th:text="${post.title}"></td>
          </tr>
          <tr>
            <td colspan="2">
              <div style="float:right;">
              <button type="button" class="btn btn-primary" id="good_btn" th:disabled="${!isLogin or isWriter}" title="이글을 추천합니다" onclick="doGood();"><i class="fa-regular fa-thumbs-up"></i><span class="badge bg-dark" id="good_cnt" th:text="${post.goodCnt}"></span></button>
              <button type="button" class="btn btn-success" id="b" disabled>조회 <span class="badge bg-danger" th:text="${post.readCnt}"></span></button>
              <button type="button" class="btn btn-danger" id="bad_btn" disabled>비추<span class="badge bg-dark"></span></button>
              </div>
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <div id="content" th:utext="${post.content}" style="min-height:400px;"></div>
            </td>
          </tr>
        </table>
        <!--  본문, 갱신 버튼, 삭제 버튼 출력 영역 -->
        <div id="btnArea" th:if="${isWriter}">
          <a type="button" class="btn btn-success" th:href="${'/post/update?pno=' + post.pno}">변경</a>
          <button type="button" class="btn btn-warning" onclick="doDelete();">삭제</button>
        </div>
        <hr>
        <div class="mb-3 mt-3" th:if="${isLogin}">
          <textarea class="form-control" rows="5" id="comment-content" style="resize:none;"></textarea>
        </div>
        <div class="mb-3 mt-3" th:if="${!isLogin}">
          <textarea class="form-control" rows="5" disabled placeholder="댓글을 작성하려면 로그인 해주세요" style="resize:none;" ></textarea>
        </div>
        <div id="commentBtnArea" th:if="${isLogin}">
          <button id="add_comment" class="btn btn-primary" onclick="doWriteComment();">댓글 추가</button>
        </div>
        <div id="comments" class="mt-3 mb-3" style="border-top: 0.8px solid rgb(221,221,221);">
          <div th:each="comment:${post.comments}" style="border-bottom: 0.8px solid rgb(221,221,221);">
            <div style="overflow:hidden;" class="mt-1 mb-1">
              <div th:text="${comment.writer}" style="float:left; font-weight:bold;"></div>
              <div th:text="${comment.writeTime}" style="float:right;"></div>
            </div>
            <div style="overflow:hidden;" class="mt-1 mb-1">
              <div th:text="${comment.content}" style="float:left;"></div>
              <button class="btn btn-danger" th:if="${comment.writer == #authentication.name}" style="float:right;" th:onclick="'deleteComment(' + ${comment.cno} + ')'">삭제</button>
            </div>
          </div>
        </div>
      </section>
    </main>
    <footer th:replace="~{/fragment/footer.html}">
    </footer>
  </div>
  <script th:inline="javascript">
    const pno = [[${ post.pno }]];
  </script>
  <script>
    function printComments($target, comments) {
      $target.empty();
      let html = '';
      for(const c of comments) {
        html += `
          <div style="border-bottom: 0.8px solid rgb(221,221,221);">
            <div style="overflow:hidden;" class="mt-1 mb-1">
              <div style="float:left; font-weight:bold;">${c.writer}</div>
              <div style="float:right;">${c.writeTime}</div>
            </div>
            <div style="overflow:hidden;" class="mt-1 mb-1">
              <div style="float:left;">${c.content}</div>
              <button class="btn btn-danger" style="float:right;" onclick="deleteComment(${c.cno});">삭제</button>
            </div>
          </div>
        `;
      }
      $target.html(html);
    }

    async function doWriteComment() {
      const content = $('#comment-content').val();
      $('#comment-content').val('');
      const params = {pno:pno, content:content};
      try {
        const response = await axios.post('/api/comments/new', new URLSearchParams(params));
        const comments = response.data;
        printComments($('#comments'), comments);
      } catch(err) {
        console.log(err);
      }
    }

    async function deleteComment(cno) {
      const params = {pno:pno, cno:cno};
      try {
        const response = await axios.delete('/api/comments', {params});
        const comments = response.data;
        const $comments = $('#comments');
        printComments($('#comments'), comments)
      } catch(err) {
        console.log(err);
      }
    }

    function doDelete() {
      const form = `
        <form action='/post/delete' method='post'>
          <input type='hidden' name='pno' value='${pno}'>
        </form>
      `;
      $(form).appendTo($('body')).submit();
    }

    async function doGood() {
      const params = {pno};
      try {
        const response = await axios.patch("/api/post/good", new URLSearchParams(params));
        const newGoodCnt = response.data;
        $('#good_cnt').text(newGoodCnt);
      } catch(err) {
        console.log(err);
      }
    }
  </script>
</body>
</html>