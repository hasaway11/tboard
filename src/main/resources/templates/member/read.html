<!DOCTYPE html>
<html lang="ko"  xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Insert title here</title>
  <link rel="stylesheet" href="/main.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/signup.js"></script>
</head>
<body>
  <div id="app">
    <header th:replace="~{/fragment/header.html}"> </header>
    <nav th:replace="~{/fragment/nav.html}"></nav>
    <main>
      <section>
        <table class="table table-hover">
          <colgroup>
            <col style="width:30%;">
            <col style="width:70%;">
          </colgroup>
          <tbody>
            <tr>
              <td colspan="2">
                <div style="height: 240px">
                  <img id="show-profile" height="240px" alt="프로필 사진" th:src="${member.profile}">
                </div>
                <div class="mb-3 mt-3">
                  <input type="file" id="profile" name="profile" accept=".jpg,.jpeg,.png" class="form-control" onchange="showProfile();">
                </div>
                <div class="mb-3 mt-3">
                  <button class="btn btn-dark form-control" onclick="changeProfile();">변경하기</button>
                </div>
              </td>
            </tr>
            <tr>
              <td>아이디</td>
              <td th:text="${member.username}"></td>
            </tr>
            <tr>
              <td>이메일</td>
              <td th:text="${member.email}"></td>
            </tr>
            <tr>
              <td>레벨</td>
              <td th:text="${member.level}"></td>
            </tr>
            <tr>
              <td>가입입</td>
              <td th:text="${member.joinday + ' (' + member.days + '일)'}"></td>
            </tr>
            <tr>
              <td colspan="2">
                <a class='btn btn-success' href='/member/change-password'>비밀번호 변경으로</a>
              </td>
            </tr>
          </tbody>
        </table>
        <button id="resign" type="button" class="btn btn-danger" onclick="resign();">탈퇴</button>
      </section>
    </main>
    <footer th:replace="~{/fragment/footer.html}"></footer>
  </div>
  <script>
    function changeProfile() {
      const formData = new FormData();
      const profile = $('#profile')[0].files[0];
      if(!profile) {
        alert("프로필 사진을 변경하세요")
        return;
      }
      formData.append('profile', profile);
      try {
        axios.patch('/api/member/profile', formData);
        // 파일 입력 필드 초기화
        $('#profile').val('');
        alert("프로필 사진을 변경했습니다");
      } catch(err) {
        alert("프로필 사진을 변경하지 못 했습니다");
        console.log(err);
      }
    }

    function resign() {
      const form = `
        <form action="/member/delete" method="post">
        </form>
      `;
      $(form).appendTo($('body')).submit();
    }
  </script>
</body>
</html>